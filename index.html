<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Statistiche Clash Royale</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0f172a;--card:#1e293b;--accent:#38bdf8;--text:#e5e7eb
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
header{padding:20px;text-align:center}
input{padding:10px;border-radius:8px;border:0;font-size:16px;margin:5px;width:calc(45% - 10px)}
button{padding:10px;border-radius:8px;border:0;font-size:16px;background:var(--accent);cursor:pointer;margin:5px;width:calc(45% - 10px);color:#fff}
nav{display:flex;flex-wrap:wrap;justify-content:center;margin-top:10px}
nav button{margin:5px;width:auto}
.card{background:var(--card);margin:15px;padding:15px;border-radius:16px}
.hidden{display:none}
img{vertical-align:middle}
.deck img{width:50px;margin:3px}
.loader{opacity:.6;text-align:center}
canvas{max-width:100% !important;height:auto !important}
@media(max-width:600px){
  input,button{width:90%}
  .deck img{width:40px;margin:2px}
}
</style>
</head>

<body>

<header>
  <h1>ğŸ‘‘ Statistiche Clash Royale</h1>
  <input id="tag1" placeholder="TAG giocatore 1">
  <input id="tag2" placeholder="TAG giocatore 2 (opzionale)">
  <button onclick="carica()">Cerca</button>
</header>

<nav class="hidden" id="nav">
  <button onclick="mostra('player')">ğŸ‘¤ Giocatore</button>
  <button onclick="mostra('battles')">âš”ï¸ Battaglie</button>
  <button onclick="mostra('clan')">ğŸ° Clan</button>
  <button onclick="mostra('cards')">ğŸƒ Carte</button>
  <button onclick="mostra('compare')">ğŸ” Confronto</button>
</nav>

<div id="player" class="card hidden"></div>
<div id="battles" class="card hidden"></div>
<div id="clan" class="card hidden"></div>
<div id="cards" class="card hidden"></div>
<div id="compare" class="card hidden"></div>

<footer style="text-align:center;font-size:12px;opacity:.6;margin:30px">
Dati forniti da RoyaleAPI & Supercell
</footer>

<script>
const API="https://proxy.royaleapi.dev/v1";
let G1,G2,B1;

function mostra(id){
  document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function mediaElisir(deck){
  return (deck.reduce((a,c)=>a+c.elixir,0)/deck.length).toFixed(2);
}

async function fetchCache(key,url){
  if(localStorage[key]) return JSON.parse(localStorage[key]);
  const d=await fetch(url).then(r=>r.json());
  localStorage[key]=JSON.stringify(d);
  return d;
}

async function carica(){
  const t1=document.getElementById("tag1").value.replace("#","").toUpperCase();
  const t2=document.getElementById("tag2").value.replace("#","").toUpperCase();

  document.getElementById("nav").classList.remove("hidden");
  document.getElementById("player").innerHTML="<p class='loader'>â³ Caricamento...</p>";

  // Fetch giocatore e battle log
  G1=await fetchCache("g1",`${API}/players/%23${t1}`);
  B1=await fetchCache("b1",`${API}/players/%23${t1}/battlelog`);
  const cards=await fetchCache("cards",`${API}/cards`);

  // GIocatore
  document.getElementById("player").innerHTML=`
    <h2>${G1.name} (#${G1.tag})</h2>
    <p>ğŸ† Coppe: ${G1.trophies} | ğŸ‘‘ Livello: ${G1.expLevel}</p>
    <p>ğŸ’§ Media elisir deck attuale: ${mediaElisir(G1.currentDeck)}</p>
    <h3>Deck attuale</h3>
    <div class="deck">
      ${G1.currentDeck.map(c=>`<img src="https://cdn.royaleapi.com/static/img/cards/${c.key}.png" title="${c.name}">`).join("")}
    </div>
    <canvas id="grafico" height="120"></canvas>
  `;

  // GRAFICO coppe/battaglie
  new Chart(document.getElementById("grafico"),{
    type:"line",
    data:{
      labels:B1.map((_,i)=>i+1),
      datasets:[{label:"Differenza coppe",data:B1.map(b=>b.team[0].crowns-b.opponent[0].crowns),borderColor:"#38bdf8",fill:false}]
    },
    options:{responsive:true,plugins:{legend:{display:false}}}
  });

  // BATTAGLIE
  document.getElementById("battles").innerHTML=
    B1.map(b=>`<div>${b.gameMode.name} â€” ${b.team[0].crowns>b.opponent[0].crowns?"âœ… Vittoria":"âŒ Sconfitta"}</div>`).join("");

  // CLAN
  if(G1.clan){
    const C=await fetchCache("clan",`${API}/clans/%23${G1.clan.tag.replace("#","")}`);
    document.getElementById("clan").innerHTML=`
      <h2>${C.name}</h2>
      <p>ğŸ‘¥ Membri: ${C.members}</p>
      <p>ğŸ† Coppe clan: ${C.clanScore}</p>
    `;
  } else document.getElementById("clan").innerHTML="Nessun clan";

  // CARTE
  document.getElementById("cards").innerHTML=
    cards.items.map(c=>`<img width="40" title="${c.name}" src="https://cdn.royaleapi.com/static/img/cards/${c.key}.png">`).join("");

  // CONFRONTO
  if(t2){
    G2=await fetchCache("g2",`${API}/players/%23${t2}`);
    document.getElementById("compare").innerHTML=`
      <h2>Confronto</h2>
      <p>${G1.name}: ${G1.trophies} ğŸ†</p>
      <p>${G2.name}: ${G2.trophies} ğŸ†</p>
    `;
  } else{
    document.getElementById("compare").innerHTML="Inserisci un secondo TAG per confrontare";
  }

  mostra("player");
}
</script>

</body>
</html>